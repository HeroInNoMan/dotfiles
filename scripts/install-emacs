#!/usr/bin/env bash
. functions.bash

EMACS_REPO_URL="https://git.savannah.gnu.org/git/emacs.git"

BRANCH="master"

if [[ $# != 0 ]]; then
  BRANCH=$1
fi

update-emacs () {
  make_title "git pull"
  cd "$HOME/repos/emacs" || exit 1
  git fetch --all --tags --prune
  git checkout "$BRANCH"
  git pull --autostash
}

clone-emacs () {
  make_title "clone"
  mkdir -p "$HOME/repos"
  cd "$HOME/repos" || exit 1
  git clone "$EMACS_REPO_URL"
  cd "$HOME/repos/emacs" || exit 1
  git checkout "$BRANCH"
}

autogen-emacs () {
  make_title "autogen"
  ./autogen.sh
  status=$?
  [ $status -eq 0 ] && notify "emacs autogen: DONE" \
      || notify "emacs autogen: FAILED"
  return $status
}

configure-emacs () {
  make_title "configure"
  ./configure # --with-native-compilation
  status=$?
  [ $status -eq 0 ] && notify "emacs configure: DONE" \
      || notify "emacs configure: FAILED"
  return $status
}

make-emacs () {
  make_title "make"
  # make NATIVE_FULL_AOT=1 -j$(nproc)
  make -j"$(nproc)"
  status=$?
  [ $status -eq 0 ] && notify "emacs make: DONE" \
      || notify "emacs make: FAILED"
  return $status
}

make-install-emacs () {
  make_title "make install"
  sudo make install
  status=$?
  [ $status -eq 0 ] && notify "emacs make install: DONE" \
      || notify "emacs make install: FAILED"
  return $status
}

OLD_DIR=$(pwd)
[[ -d "$HOME/repos/emacs/" ]] && update-emacs || clone-emacs
[ $? -eq 0 ] && autogen-emacs
[ $? -eq 0 ] && configure-emacs
[ $? -eq 0 ] && make-emacs
[ $? -eq 0 ] && make-install-emacs

cd "$OLD_DIR" || return
# EOF
